<!DOCTYPE html>
<html>

<head>
  <title> IC9 </title>
  <script src="resources/jsPsych/jspsych.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-html-button-response.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-external-html.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-html-slider-response.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-survey-text.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-survey-html-form.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="resources/jsPsych/plugins/jspsych-fullscreen.js"></script>
  <script src="jatos.js"></script>
  <link href="resources/jsPsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<style>
</style>

<body>
  <div id="welcome"></div>
</body>
<script>
    // Sample type (mturk or sona_online?)
    var sample = "sona_online"
  // var sample = "mturk"

  // MTurk code
  var turkcode = (Math.floor(Math.random() * 69696969) * 919).toString();

  // set up counterbalancing + participant condition.
  var num_random = Math.floor(Math.random() * 4) +1;
  // var num_random = 2;

  // preload in images
preload_images = [
'resources/images/RED.png',
'resources/images/BLUE.png',
'resources/images/GREY.png',
'resources/images/shock.png',
'resources/images/BLANK.png',
'resources/images/BROKEN.png',
'resources/images/pill.png',
'resources/images/healthy.png',
];

// turn images into html strings to shove into trials
  // set up counterbalancing for red/blue as target cue and set up html strings
  // Assign conditions: 

  // 1 = pos-null
  // 2 = null-null
  // 3 = neg-null

  if (num_random < 3) {
    group = 1;
    groupname = 'null-null';
    var cb = 1;
  } else if (num_random == 3) {
    group = 2;
    groupname = 'pos1-pos2-null';
    var cb = 2;
  } else if (num_random == 4) {
    group = 2;
    groupname = 'pos2-pos1-null';
    var cb = 3;
  }

    var blank = '<img src = resources/images/BLANK.png height = 200 width = 200> </img>'
    var whitespace = '<p><font color = white> text </font></p>' //white space line for formatting
    var stim_off = '<img src = resources/images/GREY.png height = 200 width = 200> </img>';
    var outcome_display = '<img src = resources/images/shock.png height = 200 width = 200> </img>';
    var outcome_text = "<p>Mr X was shocked!</p>";
    var nooutcome_text = '<p>Mr X was not shocked</p>';

    var stim_cue1 = '<img src = resources/images/BLUE.png height = 200 width = 200> </img>';
    var stim_cue2 = '<img src = resources/images/RED.png height = 200 width = 200> </img>';
    cue1_colour = "blue";
    cue2_colour = "red";

  // console.log('group ' + group);
  // console.log('group ' + groupname);
  // console.log('cb ' + cb);
  // console.log('stim 1 ' + cue1_colour);
  // console.log(num_random)


  var demographics_age = {
    type: "survey-html-form",
    preamble: "<p> Before we begin, we would like to ask some demographic questions <p>",
    html: '<p> What is your age? <input name = age type = "text"></p>',
    post_trial_gap: 250,
    on_finish: function (data) {
      age = JSON.parse(data.responses).age;
    },
  };

  var demographics_gender = {
    type: "survey-multi-choice",
    questions: [
      { prompt: 'What is your gender?', 
      options: ['Male','Female','Other'],
      name: "gender", required: true },
    ],
    on_finish: function (data) {
      gender = JSON.parse(data.responses).gender;
    },
  };

  var demographics_finish = {
    type: "html-keyboard-response",
    stimulus: "Thank you. The experiment will begin shortly",
    response_ends_trial: false,
    trial_duration: 3000,
    post_trial_gap: 500,
  };

  var timeline_demographics = {
    timeline: [
      demographics_age,
      demographics_gender,
      demographics_finish
    ]
  };


  // load stimuli (for A/B/C/D cells) into array to randomize

  // Set up A B C D trials
  // group 2 sees a medicine followed by healthy or no recovery, )

  // 1 cue trials
  var cueon1_display_delay = {
    type: "html-keyboard-response",
    stimulus: stim_cue1 +
      whitespace +
      blank +
      whitespace +
      whitespace +
      whitespace,
    response_ends_trial: false,
    trial_duration: 1000
  };

  var cueon1_display_prompt = {
    type: "html-button-response",
    stimulus: stim_cue1 +
      whitespace +
      // blank +
      whitespace,
    choices: [
      "No shock",
      "Shock"
    ],
    prompt: 
    "<p> </p>" +
    blank +
    "<p>Do you predict there will be a shock or no shock?</p>",
    on_finish: function (data) {
      trial_num++;
      // console.log(trial_num);
      jsPsych.data.get().addToLast({ trial_num: trial_num });
    }
  };

  var outcome_cueon1_delay = {
    type: "html-keyboard-response",
    stimulus: stim_cue1 +
    whitespace +
    outcome_display +
    outcome_text +
    whitespace +
    whitespace,
    response_ends_trial: false,
    trial_duration: 1500,
    post_trial_gap: 1000,
  };

  var nooutcome_cueon1_delay = {
    type: "html-keyboard-response",
    stimulus: stim_cue1 +
    whitespace +
    blank +
    whitespace +
    nooutcome_text +
    whitespace,
    response_ends_trial: false,
    trial_duration: 1500,
    post_trial_gap: 1000,
  };

  var cueoff_display_delay = {
    type: "html-keyboard-response",
    stimulus: stim_off +
    whitespace +
    blank +
    whitespace +
    whitespace +
    whitespace,
    response_ends_trial: false,
    trial_duration: 1000,
  };

  var cueoff_display_prompt = {
    type: "html-button-response",
    stimulus: stim_off +
    whitespace +
    // blank +
    whitespace ,
    choices: [
      "No shock",
      "Shock"
    ],
    prompt: 
    "<p> </p>" +
    blank +
    "<p>Do you predict there will be a shock or no shock?</p>",
    on_finish: function (data) {
      trial_num++;
      // console.log(trial_num);
      jsPsych.data.get().addToLast({ trial_num: trial_num });
    }
  };

  var outcome_cueoff_delay = {
    type: "html-keyboard-response",
    stimulus: stim_off +
    whitespace +
      outcome_display +
      whitespace +
      outcome_text +
      whitespace,
    response_ends_trial: false,
    trial_duration: 1500,
    post_trial_gap: 1000
  };

  var nooutcome_cueoff_delay = {
    type: "html-keyboard-response",
    stimulus: stim_off +
    whitespace +
    blank +
    whitespace+
    nooutcome_text +
    whitespace,
    response_ends_trial: false,
    trial_duration: 1500,
    post_trial_gap: 1000
  }

  // set up training trials for A B C D cells (contingency table)
  trial_num = 0;

    var training_trialA_cue1 = {
      timeline: [
        cueon1_display_delay,
        cueon1_display_prompt,
        outcome_cueon1_delay
      ],
      data: {
        phase: 'training',
        trialtype: 'A',
      },
    };

    var training_trialB_cue1 = {
      timeline: [
        cueon1_display_delay,
        cueon1_display_prompt,
        nooutcome_cueon1_delay
      ],
      data: {
        phase: 'training',
        trialtype: 'B',
      },
    };

    // var training_trialA_cue2 = {
    //   timeline: [
    //     cueon2_display,
    //     outcome_cueon2_delay,
    //     outcome_cueon2_prompt
    //   ],
    //   data: {
    //     phase: 'training',
    //     trialtype: 'A',
    //   },
    // };

    // var training_trialB_cue2 = {
    //   timeline: [
    //     cueon2_display,
    //     nooutcome_cueon2_delay,
    //     nooutcome_cueon2_prompt
    //   ],
    //   data: {
    //     phase: 'training',
    //     trialtype: 'B',
    //   },
    // };

    var training_trialC = {
      timeline: [
        cueoff_display_delay,
        cueoff_display_prompt,
        outcome_cueoff_delay
      ],
      data: {
        phase: 'training',
        trialtype: 'C',
      },
    };

    var training_trialD = {
      timeline: [
        cueoff_display_delay,
        cueoff_display_prompt,
        nooutcome_cueoff_delay
      ],
      data: {
        phase: 'training',
        trialtype: 'D',
      },
    };

  // set up training trial order for all blocks
    // 2 training phases to allow for a causal judgment test in between 
  var timeline_training_trials_phase1 = [];
  var timeline_training_trials_phase2 = [];
  var timeline_training_trials_phase3 = [];
  var timeline_training_trials_phase4 = [];
  var timeline_training_trials_phase5 = [];

  var training_trials_phase1_introdelay = {
    type: "html-keyboard-response",
    stimulus: "<p> Thank you, the task will begin shortly </p>",
    response_ends_trial: false,
    trial_duration: 2000,
    post_trial_gap: 500,
  };

  timeline_training_trials_phase1 = timeline_training_trials_phase1.concat(training_trials_phase1_introdelay);

// input distribution of training trials per block (9/3/3/1)
// lowered number of training trials because experiment has 6 training phases
  num_training_trialblocks = 2;

  // 0.333 delta P
  var pos1_num_training_trialA = 10; 
  var pos1_num_training_trialB = 2; 
  var pos1_num_training_trialC = 2; 
  var pos1_num_training_trialD = 2;

  // 0.666 delta P
  var pos2_num_training_trialA = 11; 
  var pos2_num_training_trialB = 1; 
  var pos2_num_training_trialC = 1; 
  var pos2_num_training_trialD = 3;
   
  var nul_num_training_trialA = 9; 
  var nul_num_training_trialB = 3; 
  var nul_num_training_trialC = 3; 
  var nul_num_training_trialD = 1;

  temp_training_blockorder_1 = [];
  temp_training_blockorder_2 = [];

  // loop to add A/B/C/D trials into a training block as inputted above
  // set up blocks for 1st contingency (pos/null/neg)
  if (group == 1) {
  for (var j = 1; j <= num_training_trialblocks; j++) {
    for (var i = 1; i <= nul_num_training_trialA; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialA_cue1)
    };

    for (var i = 1; i <= nul_num_training_trialB; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialB_cue1)
    };

    for (var i = 1; i <= nul_num_training_trialC; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialC)
    };

    for (var i = 1; i <= nul_num_training_trialD; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialD)
    };
  };
} else if (group == 2) {
  for (var j = 1; j <= num_training_trialblocks; j++) {
    for (var i = 1; i <= pos1_num_training_trialA; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialA_cue1)
    };

    for (var i = 1; i <= pos1_num_training_trialB; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialB_cue1)
    };

    for (var i = 1; i <= pos1_num_training_trialC; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialC)
    };

    for (var i = 1; i <= pos1_num_training_trialD; i++) {
      temp_training_blockorder_1 = temp_training_blockorder_1.concat(training_trialD)
    };

    for (var i = 1; i <= pos2_num_training_trialA; i++) {
      temp_training_blockorder_1b = temp_training_blockorder_1.concat(training_trialA_cue1)
    };

    for (var i = 1; i <= pos2_num_training_trialB; i++) {
      temp_training_blockorder_1b = temp_training_blockorder_1.concat(training_trialB_cue1)
    };

    for (var i = 1; i <= pos2_num_training_trialC; i++) {
      temp_training_blockorder_1b = temp_training_blockorder_1.concat(training_trialC)
    };

    for (var i = 1; i <= pos2_num_training_trialD; i++) {
      temp_training_blockorder_1b = temp_training_blockorder_1.concat(training_trialD)
    };
  };
} 

// set up blocks for the null contingency in second half of experiment
for (var j = 1; j <= num_training_trialblocks; j++) {
  for (var i = 1; i <= nul_num_training_trialA; i++) {
      temp_training_blockorder_2 = temp_training_blockorder_2.concat(training_trialA_cue1)
    };

  for (var i = 1; i <= nul_num_training_trialB; i++) {
    temp_training_blockorder_2 = temp_training_blockorder_2.concat(training_trialB_cue1)
  };

  for (var i = 1; i <= nul_num_training_trialC; i++) {
    temp_training_blockorder_2 = temp_training_blockorder_2.concat(training_trialC)
  };

  for (var i = 1; i <= nul_num_training_trialD; i++) {
    temp_training_blockorder_2 = temp_training_blockorder_2.concat(training_trialD)
  };
};

    // randomise the temporary block and add onto overall trial timeline for each loop (number of blocks)
    if (group == 1) {
      temp_training_blockorder_1 = jsPsych.randomization.shuffle(temp_training_blockorder_1);
      timeline_training_trials_phase1 = timeline_training_trials_phase1.concat(temp_training_blockorder_1);

      temp_training_blockorder_1 = jsPsych.randomization.shuffle(temp_training_blockorder_1);
      timeline_training_trials_phase2 = timeline_training_trials_phase2.concat(temp_training_blockorder_1);

    } else if (cb == 2) {
      temp_training_blockorder_1 = jsPsych.randomization.shuffle(temp_training_blockorder_1);
      timeline_training_trials_phase1 = timeline_training_trials_phase1.concat(temp_training_blockorder_1);

      temp_training_blockorder_1b = jsPsych.randomization.shuffle(temp_training_blockorder_1b);
      timeline_training_trials_phase2 = timeline_training_trials_phase2.concat(temp_training_blockorder_1b);

    } else if (cb == 3) {
      temp_training_blockorder_1b = jsPsych.randomization.shuffle(temp_training_blockorder_1b);
      timeline_training_trials_phase1 = timeline_training_trials_phase1.concat(temp_training_blockorder_1b);

      temp_training_blockorder_1 = jsPsych.randomization.shuffle(temp_training_blockorder_1);
      timeline_training_trials_phase2 = timeline_training_trials_phase2.concat(temp_training_blockorder_1);
    }
 
    // use second contingency (null) and randomize block again for phase 3
    temp_training_blockorder_2 = jsPsych.randomization.shuffle(temp_training_blockorder_2);
    timeline_training_trials_phase3 = timeline_training_trials_phase3.concat(temp_training_blockorder_2); 

    // randomize block again for phase 4
    temp_training_blockorder_2 = jsPsych.randomization.shuffle(temp_training_blockorder_2);
    timeline_training_trials_phase4 = timeline_training_trials_phase4.concat(temp_training_blockorder_2); 

    // randomize block again for phase 5
    temp_training_blockorder_2 = jsPsych.randomization.shuffle(temp_training_blockorder_2);
    timeline_training_trials_phase5 = timeline_training_trials_phase5.concat(temp_training_blockorder_2); 

  // Set up test trials:
    var test_causalratings_cue1 = {
    type: "html-slider-response",
    stimulus: stim_cue1,
    labels: [
      "<p> Definitely prevents shock </p>",
      "<p> Has no effect on shock </p>",
      "<p> Definitely causes shock <p>"
    ],
    button_label: "Continue",
    require_movement: true,
    prompt: "<p> To what extent does this light cause or prevent shock? </p>",
    post_trial_gap: 250,
    min: -100,
    max: 100,
    start: 0,
    data: {
      trialtype: "cr_cue",
      trialcategory: "cr"
    },
  };

  var test_frequency_cueon1 = {
      type: "html-slider-response",
      stimulus: stim_cue1,
      labels: [
        "<p> Shocked 0 times </p>",
        "<p> Shocked 50 times </p>",
        "<p> Shocked 100 times <p>"
      ],
      button_label: "Continue",
      require_movement: true,
      prompt: "<p> Imagine Mr X observed the shock machine 100 times and <b>only</b> saw this light.</p>" +
        "<p> How many times out of 100 do you predict Mr X will be shocked? </p>",
      post_trial_gap: 250,
      data: {
        trialtype: "fr_cue",
        trialcategory: "fr"
      },
    };

  //   var test_causalratings_cue2 = {
  //   type: "html-slider-response",
  //   stimulus: stim_cue2,
  //   labels: [
  //     "<p> Definitely prevents shock </p>",
  //     "<p> Has no effect on shock </p>",
  //     "<p> Definitely causes shock <p>"
  //   ],
  //   button_label: "Continue",
  //   require_movement: true,
  //   prompt: "<p> To what extent does this light cause or prevent shock? </p>",
  //   post_trial_gap: 250,
  //   min: -100,
  //   max: 100,
  //   start: 0,
  //   data: {
  //     trialtype: "cr_cue",
  //     trialcategory: "cr"
  //   },
  // };

  // var test_frequency_cueon2 = {
  //     type: "html-slider-response",
  //     stimulus: stim_cue2,
  //     labels: [
  //       "<p> Shocked 0 times </p>",
  //       "<p> Shocked 50 times </p>",
  //       "<p> Shocked 100 times <p>"
  //     ],
  //     button_label: "Continue",
  //     require_movement: true,
  //     prompt: "<p> Imagine Mr X observed the shock machine 100 times and <b>only</b> saw this light.</p>" +
  //       "<p> How many times out of 100 do you predict Mr X will be shocked? </p>",
  //     post_trial_gap: 250,
  //     data: {
  //       trialtype: "fr_cue",
  //       trialcategory: "fr"
  //     },
  //   };

    var test_frequency_cueoff = {
      type: "html-slider-response",
      stimulus: stim_off,
      labels: [
        "<p> Shocked 0 times </p>",
        "<p> Shocked 50 times </p>",
        "<p> Shocked 100 times <p>"
      ],
      button_label: "Continue",
      require_movement: true,
      prompt: "<p> Imagine Mr X observed the shock machine 100 times and the light was <b>always off</b>.</p>" +
        "<p> How many times out of 100 do you predict Mr X will be shocked? </p>",
      post_trial_gap: 250,
      data: {
        trialtype: "fr_off",
        trialcategory: "fr"
      },
    };

  var test_openend_causalrelationship_cue1 = {
    type: "survey-text",
    questions: [
      { prompt: 
        stim_cue1 +
      "<p>In a few sentences, how did you determine whether there was a causal relationship or not between the <b>" +cue1_colour + "</b> light and shock?</p>" +
      "<p>Please do not leave this blank. Any information you can provide is useful.</p>", 
      rows: 10, columns: 80 },
    ],
    post_trial_gap: 250,
    data: {
      trialtype: "oe_cr",
      trialcategory: "oe",
    }
  };

  // var test_openend_causalrelationship_cue2 = {
  //   type: "survey-text",
  //   questions: [
  //     { prompt: 
  //       stim_cue2 +
  //     "<p>In a few sentences, how did you determine whether there was a causal relationship or not between the <b>" +cue2_colour + "</b> light and shock?</p>" +
  //     "<p>Please do not leave this blank. Any information you can provide is useful.</p>", 
  //     rows: 10, columns: 80 },
  //   ],
  //   post_trial_gap: 250,
  //   data: {
  //     trialtype: "oe_cr",
  //     trialcategory: "oe",
  //   }
  // };

  var test_openend_othercauses = {
    type: "survey-text",
    questions: [
      {
        prompt: 
        "<p>In this experiment, did you consider any causes of shock other than the coloured lights presented? If so, please describe them. </p>" +
        "<p>Please do not leave this blank. Any information you can provide is useful.</p>", rows: 10, columns: 80
      },
    ],
    post_trial_gap: 250,
    data: {
      trialtype: "oe_oc",
      trialcategory: "oe",
    }
  };

    var test_openend_cueofftrials = {
      type: "survey-text",
      questions: [
        {
          prompt: 
        stim_off +
        "<p> On some trials, Mr X observed that the light was off but a shock still occurred.</p>" +
        "<p>What did you think caused the shock?.</p>" +
        "<p>Please do not leave this blank. Any information you can provide is useful.</p>", rows: 10, columns: 80
        },
      ],
      post_trial_gap: 250,
      data: {
        trialtype: "oe_ac",
        trialcategory: "oe",
      }
    };

    var test_causalratings_block_cue1= {
      timeline: jsPsych.randomization.shuffle([
        test_causalratings_cue1,
      ]),
    };

    // var test_causalratings_block_cue2 = {
    //   timeline: jsPsych.randomization.shuffle([
    //     test_causalratings_cue2,
    //   ]),
    // };

    var test_frequency_block_cue1 = {
      timeline: jsPsych.randomization.shuffle([
        test_frequency_cueon1,
        test_frequency_cueoff,
      ]),
    };

    // var test_frequency_block_cue2 = {
    //   timeline: jsPsych.randomization.shuffle([
    //     test_frequency_cueon2,
    //     test_frequency_cueoff,
    //   ]),
    // };

var timeline_test_trials_pretest1 = {
  timeline: [
    test_causalratings_block_cue1,
    test_frequency_block_cue1
  ],
  data: {
    phase: 'test',
    testphase: '0'
  },
};

var timeline_test_trials_interim1 = {
  timeline: [
    test_causalratings_block_cue1,
    test_frequency_block_cue1
  ],
  data: {
    phase: 'test',
    testphase: '1'
  },
};

var timeline_test_trials_interim2 = {
  timeline: [
    test_causalratings_block_cue1,
    test_frequency_block_cue1
  ],
  data: {
    phase: 'test',
    testphase: '2'
  },
};

var timeline_test_trials_interim3 = {
  timeline: [
    test_causalratings_block_cue1,
    test_frequency_block_cue1,
  ],
  data: {
    phase: 'test',
    testphase: '3'
  },
};

var timeline_test_trials_interim4 = {
  timeline: [
    test_causalratings_block_cue1,
    test_frequency_block_cue1,
  ],
  data: {
    phase: 'test',
    testphase: '4'
  },
};

var timeline_test_trials_final = {
    timeline: [
      test_causalratings_block_cue1,
      test_frequency_block_cue1,
      test_openend_causalrelationship_cue1,
      test_openend_othercauses,
      test_openend_cueofftrials,
    ],
    data: {
    phase: 'test',
    testphase: '5'
  },
};

  // welcome
  if (sample == "mturk") {
    var welcome_delay = {
      type: "html-keyboard-response",
      stimulus: "<p> Welcome to the experiment! <p>" +
        "<p> Please pay attention to <b>all tasks</b> and read <b>all instructions</b> carefully.</p>" +
        "<p> Depending on the size of your screen, you may have to scroll down some pages to observe all the information to complete your tasks. For your convenience, please change your browser to <b>fullscreen</b> mode.</p>" +
        '<p> This experiment does not require any prior knowledge, so please rely <b>only</b> on all information presented within this experiment to complete the tasks. We also ask that you do <b>not</b> write anything down. It will interfere with the results ' +
        'and will not help you complete the tasks or finish faster.</p>' +
        whitespace,
      response_ends_trial: false,
      trial_duration: 8000,
    };

    var welcome_prompt = {
      type: "html-keyboard-response",
      stimulus: "<p> Welcome to the experiment! <p>" +
        "<p> Please pay attention to <b>all tasks</b> and read <b>all instructions</b> carefully.</p>" +
        "<p> Depending on the size of your screen, you may have to scroll down some pages to observe all the information to complete your tasks. For your convenience, please change your browser to <b>fullscreen</b> mode.</p>" +
        '<p> This experiment does not require any prior knowledge, so please rely <b>only</b> on all information presented within this experiment to complete the tasks. We also ask that you do <b>not</b> write anything down. It will interfere with the results ' +
        'and will not help you complete the tasks or finish faster.</p>' +
        '<p>Press spacebar to continue</p>',
      choices: [32],
    };

    var welcome2_delay = {
      type: "html-keyboard-response",
      stimulus: '<p>If anything goes wrong during the experiment, please take a screenshot ' +
        'and notify the requester. Do <b>not</b> press the BACK button or quit out of ' +
        ' the program. This will make it hard for you to get paid.</p>' +
        '<p>If you complete the task, you will get your payment no matter what. ' +
        'Please take your time and think about your predictions and judgements seriously. </p>' +
        '<p><b>Please note that you must click on the completion link at the end of this experiment to receive your payment.</b></p>' +
        whitespace,
      response_ends_trial: false,
      trial_duration: 5000,
    };

    var welcome2_prompt = {
      type: "html-keyboard-response",
      stimulus: '<p>If anything goes wrong during the experiment, please take a screenshot ' +
        'and notify the requester. Do <b>not</b> press the BACK button or quit out of ' +
        ' the program. This will make it hard for you to get paid.</p>' +
        '<p>If you complete the task, you will get your payment no matter what. ' +
        'Please take your time and think about your predictions and judgements seriously. </p>' +
        '<p><b>Please note that you must click on the completion link at the end of this experiment to receive your payment.</b></p>' +
        "<p> Press spacebar to continue </p>",
      choices: [32],
    };
  } else if (sample == "sona_online") {
    var welcome_delay = {
      type: "html-keyboard-response",
      stimulus: "<p> Welcome to the experiment! <p>" +
        "<p> Please pay attention to <b>all tasks</b> and read <b>all instructions</b> carefully.</p>" +
        "<p> Depending on the size of your screen, you may have to scroll down some pages to observe all the information to complete your tasks. For your convenience, please change your browser to fullscreen mode.</p>" +
        '<p> This experiment does not require any prior knowledge, so please rely <b>only</b> on all information presented within this experiment to complete the tasks. We also ask that you do <b>not</b> write anything down. It will interfere with the results ' +
        'and will not help you complete the tasks or finish faster.</p>' +
        whitespace,
      response_ends_trial: false,
      trial_duration: 8000,
    };

    var welcome_prompt = {
      type: "html-keyboard-response",
      stimulus: "<p> Welcome to the experiment! <p>" +
        "<p> Please pay attention to <b>all tasks</b> and read <b>all instructions</b> carefully.</p>" +
        "<p> Depending on the size of your screen, you may have to scroll down some pages to observe all the information to complete your tasks. For your convenience, please change your browser to fullscreen mode.</p>" +
        '<p> This experiment does not require any prior knowledge, so please rely <b>only</b> on all information presented within this experiment to complete the tasks. We also ask that you do <b>not</b> write anything down. It will interfere with the results ' +
        'and will not help you complete the tasks or finish faster.</p>' +
        '<p>Press spacebar to continue</p>',
      choices: [32],
    };

    var welcome2_delay = {
      type: "html-keyboard-response",
      stimulus: '<p>Do <b>not</b> press the BACK button or quit out of ' +
        ' the program until instructed to do so. Doing so will delay the experiment and make it harder for you to get your SONA credits.</p>' +
        '<p>If you complete the task, you will get your credits no matter what. ' +
        'Please take your time and think about your predictions and judgements seriously. ' +
        'If anything goes wrong during the experiment, please ' +
        'take a screenshot and email the experimenter. </p>' +
        '<p><b>Please note that you must click on the completion link at the end of this experiment to receive your credits.</b></p>' +
        whitespace,
      response_ends_trial: false,
      trial_duration: 8000,
    };

    var welcome2_prompt = {
      type: "html-keyboard-response",
      stimulus: '<p>Do <b>not</b> press the BACK button or quit out of ' +
        ' the program until instructed to do so. Doing so will delay the experiment and make it harder for you to get your SONA credits.</p>' +
        '<p>If you complete the task, you will get your credits no matter what. ' +
        'Please take your time and think about your predictions and judgements seriously. ' +
        'If anything goes wrong during the experiment, please ' +
        'take a screenshot and email the experimenter. </p>' +
        '<p><b>Please note that you must click on the completion link at the end of this experiment to receive your credits.</b></p>' +
        "<p> Press spacebar to continue </p>",
      choices: [32],
    };
  };

  var timeline_welcome = {
    timeline: [
      welcome_delay,
      welcome_prompt,
      welcome2_delay,
      welcome2_prompt,
    ]
  };

  // TRAINING instructions
    var training_instructions_stimon_delay = {
      type: "html-keyboard-response",
      stimulus: stim_cue1 +
        "<p> In this experiment, Mr X discovers a strange machine that delivers electric shocks.</p>" +
        "<p> Mr X also notices a coloured light on the machine's interface.</p>" +
        "<p> The coloured circle above indicates the light is currently <b>ON</b>.</p>" +
        whitespace +
        whitespace,
      response_ends_trial: false,
      trial_duration: 5000
    };

    var training_instructions_stimon_prompt = {
      type: "html-keyboard-response",
      stimulus: stim_cue1 +
        "<p> In this experiment, Mr X discovers a strange machine that delivers electric shocks.</p>" +
        "<p> Mr X also notices a coloured light on the machine's interface.</p>" +
        "<p> The coloured circle above indicates the light is currently <b>ON</b>.</p>" +
        whitespace +
        '<p> Press spacebar to continue </p>',
      choices: [32],
      post_trial_gap: 250,
    };

    var training_instructions_stimoff_delay = {
      type: "html-keyboard-response",
      stimulus: stim_off +
        "<p> The light also periodically turns on and off. The grey circle above indicates the light is <b>OFF</b> </p>" +
        "<p> In a moment you will observe the machine with Mr X. Each screen will indicate one occasion in which the light was either on or off and the shock either occurred or not.</p>" +
        "<p> Please use these observations to help Mr X determine whether there is any relationship between the light and shock. </p>" +
        "<p> This task should take no more than 20 minutes. </p>" +
        whitespace +
        whitespace,
      response_ends_trial: false,
      trial_duration: 12000,
    };

    var training_instructions_stimoff_prompt = {
      type: "html-keyboard-response",
      stimulus: stim_off +
        "<p> The light also periodically turns on and off. The grey circle above indicates the light is <b>OFF</b> </p>" +
        "<p> In a moment you will observe the machine with Mr X. Each screen will indicate one occasion in which the light was either on or off and the shock either occurred or not.</p>" +
        "<p> Please use these observations to help Mr X determine whether there is any relationship between the light and shock. </p>" +
        "<p> This task should take no more than 20 minutes. </p>" +
        whitespace +
        '<p> Press spacebar to continue </p>',
      choices: [32],
      post_trial_gap: 250,
    };

    var training_instructions_newstim_delay = {
      type: "html-keyboard-response",
      stimulus: stim_cue2 +
        "<p> Mr X notices that the light on the strange machine has now changed colour.</p>" +
        "<p> The coloured circle above indicates the light is currently <b>ON</b>.</p>" +
        whitespace +
        whitespace,
      response_ends_trial: false,
      trial_duration: 5000
    };

    var training_instructions_newstim_prompt = {
      type: "html-keyboard-response",
      stimulus: stim_cue2 +
        "<p> Mr X notices that the light on the strange machine has now changed colour.</p>" +
        "<p> The coloured circle above indicates the light is currently <b>ON</b>.</p>" +
        whitespace +
        '<p> Press spacebar to continue </p>',
      choices: [32],
      post_trial_gap: 250,
    };

    var training_instructions_newstim_delay2 = {
      type: "html-keyboard-response",
      stimulus: stim_cue2 +
      "<p> In a moment you will observe the machine again with Mr X. Each screen will indicate one occasion in which the light was either on or off and the shock either occurred or not.</p>" +
      "<p> Please use these observations to help Mr X determine whether there is any relationship between the light and shock. </p>" +
        whitespace +
        whitespace,
      response_ends_trial: false,
      trial_duration: 5000
    };

    var training_instructions_newstim_prompt2 = {
      type: "html-keyboard-response",
      stimulus: stim_cue2 +
      "<p> In a moment you will observe the machine again with Mr X. Each screen will indicate one occasion in which the light was either on or off and the shock either occurred or not.</p>" +
      "<p> Please use these observations to help Mr X determine whether there is any relationship between the light and shock. </p>" +
        whitespace +
        '<p> Press spacebar to continue </p>',
      choices: [32],
      post_trial_gap: 250,
    };
    
  // training instructions block
    var timeline_training_instructions1 = {
      timeline: [
        training_instructions_stimon_delay,
        training_instructions_stimon_prompt,
        training_instructions_stimoff_delay,
        training_instructions_stimoff_prompt,
      ],
    };

    // var timeline_training_instructions2 = {
    //   timeline: [
    //     training_instructions_newstim_delay,
    //     training_instructions_newstim_prompt,
    //     training_instructions_newstim_delay2,
    //     training_instructions_newstim_prompt2,
    //   ],
    // };

  //instruction check
  var Q0_text = "What is the aim of your task?";

    var Q0_answers = [
    "To shock Mr X with the machine as much as possible",
    "To prevent Mr X from getting shocked by the machine",
    "To determine whether or not the machine's lights are related to electric shocks"
  ];
  var Q1_text = "What does a plain grey circle represent on the machine?";
    var Q1_answers = [
    "The light is on",
    "The light is broken",
    "The light is off",
  ];
  
  var correctstring = '{"Q0":"' + Q0_answers[2] + '","Q1":"' + Q1_answers[2] + '"}';

  //instruction check loop
  var instruction_check_block = [];

  var instructioncorrect = false;
  failedfirstcheck = false;

  var instruction_check = {
    type: "survey-multi-choice",
    preamble: "<p> Please answer the following question(s) to confirm you understand the task instructions. </p>" +
      "<p><b> Please note, if you make a mistake, you will be asked to answer these questions again. </b> </p>",
    questions: [
      { prompt: Q0_text, options: Q0_answers, name: "Q0", required: true },
      { prompt: Q1_text, options: Q1_answers, name: "Q1", required: true },
    ],
    post_trial_gap: 250,
    on_finish: function (data) {
      if (data.responses == correctstring) {
        instructioncorrect = true;
      }
    }    
  };

  instruction_check_block = instruction_check_block.concat(instruction_check);

  // incorrect response screen
  var splash_incorrect = {
    type: 'html-keyboard-response',
    stimulus: '<center>Unfortunately, at least one of your answers was incorrect. Please try again in 5 seconds. </center>',
    response_ends_trial: false,
    trial_duration: 5000,
    on_finish: function (data) {
      failedfirstcheck = true;
    }
  };

  // push it to a conditional node that only shows it if the response was wrong
  var conditional_splash = {
    timeline: [splash_incorrect],
    conditional_function: function (data) {
      return !instructioncorrect // skip if correct
    }
  };

  instruction_check_block = instruction_check_block.concat(conditional_splash);

  // finally, turn instruction check into loop block
  var timeline_instruction_check = {
    timeline: instruction_check_block,
    loop_function: function (data) {
      //var action = true;
      return !instructioncorrect // stop looping if correct
    },
  };

  // TEST instructions
  
  test_text = "shock machine";

  var test_instructions_pretest1_delay = {
    type: "html-keyboard-response",
    stimulus:
    "<p> Before we begin, we would like to ask you for your initial thoughts about the " +  test_text + ".</p>" +
    "<p> Please answer by adjusting the slider on the scale provided. </p>" +
    whitespace,
    response_ends_trial: false,
    trial_duration: 4000,
  };

  var test_instructions_pretest1_prompt = {
    type: "html-keyboard-response",
    stimulus:
    "<p> Before we begin, we would like to ask you for your initial thoughts about the " +  test_text + ".</p>" +
      "<p> Please answer by adjusting the slider on the scale provided. </p>" +
      "<p> Press spacebar to continue </p>",
      post_trial_gap: 500
  };

  test_text = "<b>this</b> shock machine";

var test_instructions_pretest2_delay = {
  type: "html-keyboard-response",
  stimulus:
  "<p> Before we begin, we would like to ask you for your initial thoughts about the <b>new</b> " +  test_text + ".</p>" +
  "<p> Please answer by adjusting the slider on the scale provided. </p>" +
  whitespace,
  response_ends_trial: false,
  trial_duration: 4000,
};

var test_instructions_pretest2_prompt = {
  type: "html-keyboard-response",
  stimulus:
  "<p> Before we begin, we would like to ask you for your initial thoughts about <b>new</b> " +  test_text + ".</p>" +
    "<p> Please answer by adjusting the slider on the scale provided. </p>" +
    "<p> Press spacebar to continue </p>",
    post_trial_gap: 500
};

  var timeline_test_instructions_pretest1 = {
    timeline: [
      test_instructions_pretest1_delay,
      test_instructions_pretest1_prompt,
    ]
  };

  // var timeline_test_instructions_pretest2 = {
  //   timeline: [
  //     test_instructions_pretest2_delay,
  //     test_instructions_pretest2_prompt,
  //   ]
  // };

  // experiment finished instructions
  if (sample == "mturk") {
    var experiment_end_instructions_delay = {
      type: "html-keyboard-response",
      stimulus: "<p> The experiment has now concluded. Thank you for your participation.</p>" +
        "<p> Your completion code is </p>" + turkcode + "<p>To receive payment for the HIT, return to the Amazon Mechanical Turk page and enter this code. Please contact us if something goes wrong and we'll fix it as quickly as possible. </p>" +
        "<p> This page will automatically close in 1 minute. Feel free to exit the experiment once you've recorded your completion code. </p>",
      response_ends_trial: false,
      trial_duration: 60000,
      on_finish: function () {
        jsPsych.data.addProperties({
          id: jatos.workerId,
          failedfirstcheck: failedfirstcheck
        })
      },
    };
  } else {
    var experiment_end_instructions_delay = {
      type: "html-button-response",
      stimulus: "<p> The experiment has now concluded. Thank you for your participation!</p>" +
        "<p> Please click 'Continue' to be debriefed and receive your SONA credits. </p>",
      response_ends_trial: true,
      choices: ['Continue'],
      post_trial_gap: 250,
    };
  };

  var timeline_experiment_end = {
    timeline: [
      experiment_end_instructions_delay,
      // experiment_end_instructions_prompt
    ]
  };

  // load in consent and debrief forms 
  var consent = {
    type: "external-html",
    url: "consent.html",
    cont_btn: "consented",
    // check_fn: function () {
    //   jsPsych.data.addProperties(
    //     {
    //       wants_copy: document.getElementById("copy").checked,
    //     }
    //   );
    //   return true;
    // }
  };

  var debrief = {
    type: "external-html",
    url: "debrief.html",
    cont_btn: "been_debriefed",
  };


  // put it all together
  var timeline = [];

  timeline = timeline.concat(consent);
  timeline = timeline.concat(timeline_welcome);
  timeline = timeline.concat(timeline_demographics);
  timeline = timeline.concat(timeline_training_instructions1);
  timeline = timeline.concat(timeline_instruction_check);

  timeline = timeline.concat(timeline_test_instructions_pretest1);
  timeline = timeline.concat(timeline_test_trials_pretest1);

  timeline = timeline.concat(timeline_training_trials_phase1);
  timeline = timeline.concat(timeline_test_trials_interim1);

  timeline = timeline.concat(timeline_training_trials_phase2);
  timeline = timeline.concat(timeline_test_trials_interim2);

  timeline = timeline.concat(timeline_training_trials_phase3);
  timeline = timeline.concat(timeline_test_trials_interim3);

  timeline = timeline.concat(timeline_training_trials_phase4);
  timeline = timeline.concat(timeline_test_trials_interim4);

  timeline = timeline.concat(timeline_training_trials_phase5);

  timeline = timeline.concat(timeline_test_trials_final);
  timeline = timeline.concat(timeline_experiment_end);
  timeline = timeline.concat(debrief);

    jatos.onLoad(function () {

      // SONA auto crediting stuff
      var sona_id = jatos.urlQueryParameters.id;// jsPsych.data.getURLVariable("id");

              // ID is undefined if not coming from Sona
              if (sona_id === undefined) {
            sona_id = null; 
        }

      var completion_url = "https://unsw-psy.sona-systems.com/webstudy_credit.aspx?experiment_id=1617&credit_token=3ee4afadec824d1995315a757d79f1e5&survey_code=" + sona_id;
      
      var finish_msg = 'All done! Your SONA ID is ' + sona_id + '<p><b>Please note that you must click on the completion link at the end of this experiment to receive your payment. </b></p>' + '<p>Please click <a href="' + completion_url + '">here</a> to return to SONA and receive your credit</p>' + 'If anything goes wrong, please let us know immediately.' + 
        '<p>Thank you for participating!</p>';


      // add properties to each trial in the jsPsych data

      jsPsych.init({
        timeline: timeline,
        show_progress_bar: false,
        preload_images: preload_images,
        on_finish: function () {
          jsPsych.data.addProperties({
            id: jatos.workerId,
            failedfirstcheck: failedfirstcheck,
            age: age,
            gender: gender,
            group: group,
            groupname: groupname,
            cb: cb,
            cue1_colour: cue1_colour,
            cue2_colour: cue2_colour,
            sona_id: sona_id, // turkcode: turkcode,
          });
          var result = jsPsych.data.get().csv();
          jatos.submitResultData(result, 
          function () {
            document.write('<div id="endscreen" class="endscreen" style="width:1000px"><div class="endscreen" style="text-align:center; border:0px solid; padding:10px; font-family: Arial; font-size:120%; width:800px; float:right"><p><br><br><br>' +
              finish_msg +
              '</p></div></div>')
          });
        },
      });
    });

</script>

</html>